## Что такое ДДД  

Разработка программного обеспечения чаще всего применяется для автоматизации процессов, существующих в реальном мире, или для предоставления решений реальных бизнес‑проблем; бизнес‑процессы, которые автоматизируются, или реальные проблемы, которые решает программное обеспечение, образуют домен программного обеспечения. Мы должны понимать с самого начала, что программное обеспечение происходит из этого домена и тесно с ним связано.  

Программное обеспечение состоит из кода. Мы можем быть склонны тратить слишком много времени на код и рассматривать программное обеспечение просто как набор объектов и методов.  

Возьмём производство автомобилей как метафору. Рабочие, участвующие в производстве автомобилей, могут специализироваться на изготовлении отдельных деталей, но при этом у них часто ограниченное представление о полном процессе производства автомобиля. Они начинают видеть автомобиль как огромную коллекцию деталей, которые нужно собрать вместе, но автомобиль — это гораздо больше. Хороший автомобиль начинается с видения. Он начинается с тщательно написанных спецификаций. И продолжается проектированием. Много‑много проектирования. Месяцы, возможно, годы, потраченные на проектирование, его изменение и уточнение, пока он не достигнет совершенства, пока не отразит исходное видение. Проектирование не ограничивается только бумагой. Большая часть его включает создание моделей автомобиля и их тестирование в определённых условиях, чтобы увидеть, работают ли они. Проектирование модифицируется на основе результатов тестов. В конце концов автомобиль отправляется в производство, детали создаются и собираются вместе.  

Разработка программного обеспечения похожа. Мы не можем просто сесть и печатать код. Мы можем это сделать, и это работает для тривиальных случаев. Но мы не можем создать сложное программное обеспечение таким способом.  

Чтобы создать хорошее программное обеспечение, нужно знать, о чём оно. Вы не можете создать банковскую систему, если не понимаете, что такое банковское дело; необходимо понять домен банковского дела.  

Можно ли создать сложное банковское программное обеспечение без хороших знаний домена? Ни за что. Кто знает банковское дело? Архитектор программного обеспечения? Нет. Он просто использует банк, чтобы хранить свои деньги в безопасности и иметь к ним доступ, когда нужно. Аналитик программного обеспечения? Не совсем. Он умеет анализировать заданную тему, когда ему предоставлены все необходимые ингредиенты. Разработчик? Забудьте. Кто тогда? Банкиры, конечно. Систему банковского дела хорошо понимают люди внутри, их специалисты. Они знают все детали, все подводные камни, все возможные проблемы, все правила. Именно с этого места мы всегда должны начинать: с домена.  

Когда мы начинаем проект программного обеспечения, мы должны сосредоточиться на домене, в котором он работает. Вся цель программного обеспечения — улучшить конкретный домен. Чтобы это сделать, программное обеспечение должно гармонично вписываться в домен, для которого оно создано. Иначе оно будет создавать напряжение в домене, вызывая сбои, повреждения и даже хаос.  

Как сделать программное обеспечение гармоничным с доменом? Лучший способ — сделать программное обеспечение отражением домена. Программное обеспечение должно включать основные концепции и элементы домена и точно реализовывать их взаимосвязи. Программное обеспечение должно моделировать домен.  

Человек без знаний банковского дела должен уметь многое узнать, просто читая код в доменной модели. Это необходимо. Программное обеспечение, корни которого не глубоко укоренены в домене, не будет хорошо реагировать на изменения со временем.  

Итак, мы начинаем с домена. Что дальше? Домен — это нечто из реального мира. Его нельзя просто взять и вбить в клавиатуру, превратив в код. Нужно создать абстракцию домена. Мы узнаём многое о домене, разговаривая с экспертами домена. Но эти сырые знания не преобразуются легко в программные конструкции, если мы не построим их абстракцию, чертёж в нашем сознании. В начале чертёж всегда неполный. Но со временем, работая над ним, мы делаем его лучше, и он становится всё яснее. Что это за абстракция? Это модель, модель домена. По словам Эрика Эванса, доменная модель — это не конкретная диаграмма; это идея, которую диаграмма должна передавать. Это не просто знание в голове эксперта домена; это строго организованная и избирательная абстракция этого знания. Диаграмма может представлять и передавать модель, как и тщательно написанный код, как и английское предложение.

Модель — наше внутреннее представление целевого домена, и она необходима на протяжении всего процесса проектирования и разработки. Во время проектирования мы постоянно ссылаемся на модель. Мир вокруг нас слишком велик, чтобы уместиться в нашей голове. Даже конкретный домен может превысить возможности человеческого разума в один момент. Нам нужно упорядочить информацию, систематизировать её, разбить на более мелкие части, сгруппировать эти части в логические модули и работать с ними поочерёдно. Иногда нужно исключить некоторые части домена. Домен содержит слишком много информации, чтобы включить её всю в модель. И большая часть этой информации вовсе не нужна. Это уже сама по себе задача. Что оставить, а что выбросить? Это часть процесса проектирования, создания программного обеспечения. Банковское программное обеспечение, конечно, будет хранить адрес клиента, но не должно интересоваться цветом его глаз. Это очевидный пример, но другие примеры могут быть не столь очевидны.  

Модель — неотъемлемая часть проектирования программного обеспечения. Она нужна, чтобы справиться со сложностью. Всё наше мышление о домене синтезируется в этой модели. Это хорошо, но модель должна выйти из нашей головы. Оставаясь в голове она не особо полезна, верно? Мы должны передать эту модель экспертам домена, коллегам отвечающим за проектирование системы и разработчикам. Модель — сущность программного обеспечения, но нам нужны способы её выражения, её коммуникации с другими. Мы не одни в этом процессе, поэтому нужно делиться знаниями и информацией, делая это точно, полностью и без двусмысленности. Существует несколько способов. Один — графический: диаграммы (например use case diagram), рисунки, картинки и т.п. Другой — письменный: мы фиксируем наше видение домена. Третий — язык. Мы можем и должны создать язык для общения о специфических вопросах домена. Мы подробно рассмотрим всё это позже, но главное — нужно передать модель.  

Когда модель выражена, мы можем приступить к проектированию кода. Это отличается от проектирования программного обеспечения. Проектирование программного обеспечения — это создание архитектуры дома, общая картина. Проектирование кода — работа над деталями, например, расположением картины на конкретной стене. Проектирование кода тоже важно, но не так фундаментально, как проектирование программного обеспечения. Ошибку в проектировании кода обычно легче исправить, тогда как ошибки в проектировании программного обеспечения обходятся дороже. Переместить картину чуть левее — дело одно, а снести одну сторону дома, чтобы сделать её иначе, — совсем другое. Тем не менее конечный продукт не будет хорошим без хорошего проектирования кода. Здесь на помощь приходят паттерны проектирования, которые следует применять при необходимости. Хорошие техники кодирования помогают создавать чистый, поддерживаемый код.  

Существует несколько подходов к проектированию программного обеспечения. Один — метод waterfall. Этот метод включает несколько этапов. Бизнес‑эксперты формулируют набор требований, которые передаются бизнес‑аналитикам. Аналитики создают модель на основе этих требований и передают результаты разработчикам, которые начинают писать код на основе полученного. Это односторонний поток знаний. Хотя такой традиционный подход использовался с определённым успехом на протяжении лет, у него есть недостатки и ограничения. Главная проблема — отсутствие обратной связи от аналитиков к бизнес‑экспертам и от разработчиков к аналитикам.

Другой подход — Agile‑методологии, такие как Extreme Programming (XP). Эти методологии представляют собой коллективное движение против waterfall‑подхода, возникшее из трудностей создания полного набора требований заранее, особенно с учётом их изменения. Точно также трудно заранее создать полную модель, охватывающую все аспекты домена. Требуется много размышлений, и часто невозможно увидеть все проблемы с самого начала, а также предсказать негативные побочные эффекты или ошибки проектрования. Ещё одна проблема, которую решает Agile, — так называемый "аналитический паралич”, когда члены команды настолько боятся принимать любые архитектурные решения, что прогресс останавливается. Agile‑приверженцы признают важность архитектурных решений, но сопротивляются их предварительному определению. Вместо этого они используют большую гибкость реализации и через итеративную разработку с постоянным участием бизнес‑стейкхолдеров и обильным рефакторингом команда получает больше знаний о домене клиента и может лучше создавать программное обеспечение, отвечающее потребностям заказчика.  

Agile‑методы имеют свои проблемы и ограничения; они пропагандируют простоту, но у каждого своё представление о том, что это значит. Кроме того, постоянный рефакторинг, выполненный разработчиками без надёжных принципов проектирования, приводит к коду, трудно понимаемому и изменяемому. И в то время как waterfall‑подход может привести к переинжинирингу, страх переинжиниринга может породить другой страх: страх глубокой, тщательно продуманной разработки.  

Эта книга излагает принципы доменно ориентированного проектирования (Domain-Driven Design / DDD). При грамотном применении они способны значительно повысить способность любого процесса разработки моделировать и реализовывать сложные задачи предметной области так, чтобы результат оставался сопровождаемым. ДДД объединяет практики проектирования и разработки и показывает, как они могут работать вместе, чтобы получать более удачные решения. Хорошее проектирование ускоряет разработку, а обратная связь из процесса разработки, в свою очередь, улучшает проектирование.

### Построение знаний о домене

Рассмотрим пример проекта системы управления полётами самолёта и то, как можно построить знания о домене.  

Тысячи самолётов находятся в воздухе в любой момент по всему планете. Они летят по своим маршрутам к пунктам назначения, и очень важно убедиться, что они не столкнутся в воздухе. Мы не будем подробно рассматривать всю систему управления воздушным движением, а сосредоточимся на более узком подпроекте — системе мониторинга полётов. Предлагаемый проект — система мониторинга, которая отслеживает каждый полёт над определённой территорией, определяет, следует ли полёт запланированному маршруту, и есть ли риск столкновения.

С чего начать с точки зрения разработки программного обеспечения? В предыдущем разделе мы сказали, что следует начинать с понимания домена, которым в данном случае является мониторинг воздушного движения. Специалисты по контролю воздушного движения — это эксперты этого домена. Но они не являются проектировщиками систем или специалистами по программному обеспечению. Не стоит ожидать, что они предоставят полное описание своей проблемной области.

Контролёры воздушного движения обладают обширными знаниями о своём домене, но чтобы построить модель, нужно извлечь из этих знаний существенную информацию и обобщить её. Когда вы начинаете с ними разговаривать, вы услышите много о взлётах и посадках самолётов, о полётах в воздухе и опасности столкновения, о самолётах, ожидающих разрешения на посадку и т.д. Чтобы упорядочить этот, казалось бы, хаотичный поток информации, нужно где‑то начать.  

Контролёр и вы согласились, что каждый самолёт имеет аэропорт вылета и аэропорт назначения. Итак, у нас есть самолёт (Aircraft), вылет (Departure) и назначение (Destination), как показано на рисунке ниже.  

![](../img/image2.png)

Хорошо, самолёт взлетает из одного места и приземляется в другом. Но что происходит в воздухе? Какой путь он проходит? На самом деле нас интересует, что происходит, пока он находится в воздухе. Контролёр говорит, что каждому самолёту назначен план полёта, который должен описывать всё воздушное путешествие. Слышая о плане полёта, вы можете подумать, что речь идёт о пути, по которому летит самолёт в воздухе. После дальнейшего обсуждения вы слышите интересное слово: маршрут (route). Оно сразу привлекает ваше внимание, и не без причины. Маршрут содержит важную концепцию полётного путешествия. Это то, что делают самолёты, летая — они следуют по маршруту. Очевидно, что точки вылета и назначения самолёта также являются начальной и конечной точками маршрута. Поэтому вместо того, чтобы связывать самолёт с точками вылета и назначения, естественнее связать его с маршрутом, который, в свою очередь, связан с соответствующими точками вылета и назначения.

![](../img/image3.png)

Говоря с контролёром о маршрутах, по которым летают самолёты, вы обнаруживаете, что на самом деле маршрут состоит из небольших сегментов, которые в совокупности образуют некую изогнутую линию от вылета до назначения. Эта линия должна проходить через предопределённые фиксированные точки (fixes). Таким образом, маршрут можно рассматривать как последовательность последовательных фиксированных точек. На этом этапе вы уже не видите вылет и назначение как конечные точки маршрута, а просто как ещё две из фиксированных точек. Это, вероятно, отличается от того, как контролёр их видит, но это необходимая абстракция, которая поможет позже. В результате изменений, основанных на этих открытиях, получаем:  

![](../img/image4.png)

Диаграмма показывает ещё один элемент — то, что каждый fix является точкой в пространстве, следуемой за route, и выражается как трёхмерная точка (3DPoint). Но когда вы говорите с контролёром, вы обнаружите, что он так не видит. На самом деле он воспринимает route как проекцию на землю полёта самолёта. Fixes — это просто точки на поверхности Земли, однозначно определяемые их широтой и долготой. Поэтому правильная диаграмма выглядит так:  

![](../img/image5.png)

Что происходит на самом деле? Вы и эксперты домена разговариваете, обмениваетесь знаниями. Вы задаёте вопросы, они отвечают. При этом они извлекают из воздушного домена ключевые концепции. Эти концепции могут быть неотшлифованными и неорганизованными, но они необходимы для понимания домена. Нужно узнать как можно больше о домене от экспертов. Задавая правильные вопросы и правильно обрабатывая информацию, вы и эксперты начнёте формировать представление о домене — доменную модель. Это представление ни полностью, ни точно, но это тот старт, который вам нужен. Старайтесь определить основные концепции домена.  

Это важная часть проектирования. Обычно между архитекторами программного обеспечения или разработчиками и экспертами домена проходят длительные обсуждения. Специалисты по программному обеспечению хотят извлечь знания у экспертов домена и преобразовать их в полезную форму. В какой‑то момент они могут захотеть создать ранний прототип, чтобы увидеть, как всё работает на данный момент. Делая это, они могут обнаружить проблемы в своей модели или подходе и захотеть изменить модель. Коммуникация происходит не только в одну сторону — от экспертов домена к архитектору и дальше к разработчикам. Есть также обратная связь, которая помогает создать лучшую модель и более чёткое и правильное понимание домена. Эксперты домена хорошо знают свою область, но они организуют и используют свои знания специфическим образом, который не всегда оптимален для реализации в программной системе. Аналитический ум дизайнера программного обеспечения помогает выявить ключевые концепции домена во время обсуждений с экспертами и также помогает построить структуру для будущих обсуждений, как мы увидим в следующей главе. Мы, специалисты по программному обеспечению (архитекторы и разработчики), и эксперты домена создаём модель домена вместе, и модель — это место, где встречаются эти две области экспертизы. Это может показаться очень трудоёмким процессом, и так оно и есть, но так должно быть, потому что в конечном итоге цель программного обеспечения — решать бизнес‑проблемы в реальном домене, поэтому оно должно идеально вписываться в домен.