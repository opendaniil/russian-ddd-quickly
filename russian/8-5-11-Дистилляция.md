### Дистилляция

Дистилляция это процесс разделения веществ, из которых состоит смесь. Цель дистилляции извлечь из смеси конкретное вещество. В процессе дистилляции могут получиться побочные продукты, и они тоже могут быть интересны.

Большой домен даёт большую модель даже после того, как мы её уточнили и навели абстракций. Она может оставаться большой и после множества рефакторингов. В таких ситуациях, возможно, пора переходить к дистилляции. Идея в том, чтобы выделить Ядро домена (Core Domain), который отражает сущность домена. А побочными продуктами дистилляции станут универсальные поддомены (Generic Subdomains), из которых и будут состоять остальные части домена.

При проектировании большой системы компонентов так много, все они сложные и вроде бы жизненно важные для успеха, что сущность доменной модели, настоящий бизнес-актив, легко теряется из виду и остаётся без должного внимания.

Работая с большой моделью, стоит отделять ключевые концепты от универсальных. В начале мы приводили пример системы мониторинга воздушного движения. Мы говорили, что план полёта содержит спроектированный маршрут, по которому самолёт должен лететь. Маршрут кажется вездесущим понятием в этой системе. На самом деле это универсальный концепт, а не ключевой. Понятие Маршрута встречается во многих доменах, и под него можно сделать универсальную модель. Суть мониторинга воздушного движения находится в другом месте. Система мониторинга знает маршрут, по которому самолёт должен следовать, но также получает данные от сети радаров, отслеживающих самолёт в воздухе. Эти данные показывают фактическую траекторию полёта, и она обычно отличается от “предписанной”. Система должна вычислять траекторию самолёта на основе текущих параметров полёта, характеристик самолёта и погоды. Траектория это четырёхмерный путь, который полностью описывает, как самолёт будет двигаться во времени. Траекторию можно считать на ближайшие пару минут, на десятки минут или на несколько часов вперёд. Каждый такой расчёт помогает принимать решения. Вся цель вычисления траектории понять, есть ли шанс, что путь этого самолёта пересечётся с путём другого. В районе аэропортов, во время взлёта и посадки, много самолётов кружат или выполняют манёвры. Если самолёт уходит с запланированного маршрута, вероятность аварии резко возрастает. Система мониторинга вычисляет траектории самолётов и поднимает тревогу, если есть вероятность пересечения. Диспетчеры должны быстро принимать решения и перенаправлять самолёты, чтобы избежать столкновения. Когда самолёты дальше друг от друга, траектории считают на более длинные интервалы, и времени на реакцию больше. Модуль, который синтезирует траекторию самолёта из доступных данных это сердце бизнес-системы в этом примере. Его и нужно выделить как Ядро Домена (Core Domain). А модель маршрутов это скорее универсальный домен.

Ядро домена зависит от того, как мы смотрим на систему. В простой системе маршрутизации, Маршрут и всё, что вокруг него, будет центральным для проектирования. А система мониторинга воздушного движения будет считать Маршрут универсальным поддоменом. Ядро домена одного приложения вполне может оказаться универсальным поддоменом другого. Важно правильно выделить ядро и определить, как оно связано с остальными частями модели.

Сведите модель к сути. Найдите Ядро домена и сделайте так, чтобы его было легко отличать от массы поддерживающей модели и кода. Подсветите самые ценные и специализированные концепты. Сделайте ядро маленьким.

Отдайте Ядро домена лучшим людям и подбирайте команду под это. Вкладывайте усилия именно в ядро, чтобы найти глубокую модель и вырастить гибкий, пластичную архитектуру, достаточную для реализации видения системы. Инвестиции в любые другие части оправдывайте тем, как именно они поддерживают выделенное ядро.

Важно поручать реализацию Ядро домена самым сильным разработчикам. Разработчикам обычно интереснее технологии, выучить самый новый язык, освоить свежий стек. Их чаще тянет в инфраструктуру, а не в доменную логику. Доменная бизнес-логика кажется им скучной и неокупаемой. В самом деле, какой смысл разбираться в специфике, например, траекторий самолётов? Проект закончится, и эти знания останутся в прошлом, почти без выгоды на будущее. Но доменная логика это сердце предметной области. Ошибки в проектировании и реализации ядра могут привести к тому, что проект придётся вообще бросить. Если ключевая доменная логика не делает свою работу, все технологические навороты не будут стоить ничего.

Ядро домена обычно не появляется одним финальным шагом. Нужен процесс уточнения, последовательные рефакторинги необходимы, чтобы ядро проявилось яснее. Нам нужно жёстко закрепить ядро как центральную часть проектирования и очертить его границы. Также нужно пересмотреть остальные элементы модели в отношении нового Ядра. Их тоже может понадобиться рефакторить, а часть функциональности возможно придётся изменить.

Некоторые части модели добавляют сложность, но при этом не фиксируют и не передают специализированное знание. Всё лишнее делает Ядро домена труднее заметить и понять. Модель забивается общими принципами, которые всем и так известны, или деталями из областей, которые не являются вашим главным фокусом, а играют вспомогательную роль. И всё же, какими бы общими ни были эти элементы, они необходимы для работы системы и для полноценного выражения модели.

Определите целостные поддомены, которые не являются причиной, ради которой вообще делается ваш проект. Вынесите их типовые (generic) модели и разместите в отдельных Модулях. Не тащите туда ничего специфичного для вашей предметной области.

После того как они отделены, держите их дальнейшее развитие в более низком приоритете, чем Ядро домена (Core Domain), и не назначайте на эти задачи разработчиков ядра (они почти не получат оттуда доменного знания). Также рассмотрите готовые коробочные решения или опубликованные модели для таких типовых поддоменов (Generic Subdomains).

Любая предметная область использует понятия, которые встречаются и в других доменах. Деньги и связанные с ними концепты вроде валюты и обменного курса могут присутствовать в самых разных системах. Charting (построение графиков) ещё один широко используемый концепт, он сам по себе очень сложный, но применяется во множестве приложений.

Есть разные способы реализовать типовой поддомен (Generic Subdomain):

1. Готовое коробочное решение.
   Плюс в том, что всё решение уже сделано кем то другим. Но остаётся кривая обучения, и такое решение приносит зависимости. Если в коде баг, вам придётся ждать, пока его исправят. Также вы привязываетесь к конкретным компиляторам и версиям библиотек. Интегрировать такое решение обычно сложнее, чем собственную реализацию.
2. Аутсорсинг.
   Проектирование и реализация отдаются другой команде, скорее всего из другой компании. Это позволяет сосредоточиться на Ядре домена (Core Domain) и снимает с вас нагрузку ещё одной предметной области. Но остаётся неудобство интеграции внешнего кода. Интерфейс (контракт), через который вы взаимодействуете с поддоменом, нужно чётко зафиксировать и донести до внешней команды.
3. Готовая модель.
   Практичный вариант — взять уже созданную модель. В некоторых книгах опубликованы паттерны анализа (analysis patterns); их можно использовать как источник идей для наших поддоменов. Скорее всего не получится копировать их дословно, но многие можно применить с небольшими изменениями.
4. Внутренняя реализация.
   Плюс в том, что так проще всего добиться лучшей интеграции. Минус это дополнительные усилия и стоимость владения, включая поддержку и сопровождение.